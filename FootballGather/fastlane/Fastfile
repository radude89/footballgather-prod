default_platform(:ios)

before_all do
  xcversion(version: "~> 13.0")
  clear_derived_data
end

SIMULATORS = [
  'iPhone 8'
]

platform :ios do
  desc "Runs the unit tests of FootballGather"
  lane :ut do
    scan(
      scheme: "FootballGather-CI",
      clean: true,
      reset_simulator: true
    )
  end

  desc "Runs the UI tests of FootballGather"
  lane :ui do
    scan(
      scheme: "UITests",
      clean: true,
      reset_simulator: true,
      devices: SIMULATORS
    )
  end

  desc "Takes screenshots"
  lane :screenshots do
    capture_ios_screenshots(
      clear_previous_screenshots: true
    )

    capture_ios_screenshots(
      dark_mode: true
    )
  end

  desc "Distributes IPA to AppStore"
  lane :distribute_release_app do
    build_release_app
    app_store_connect
    pilot(
      distribute_external: false,
      notify_external_testers: false,
      skip_waiting_for_build_processing: true,
      skip_submission: true
    )
  end

  private_lane :build_release_app do
    version_number = sh("git describe --tags --abbrev=0")
    increment_build_number
    increment_version_number(
      version_number: version_number
    )
    gym(
      scheme: "FootballGather",
      clean: true,
      output_directory: "./build-store",
      export_method: "app-store"
    )
  end

  private_lane :app_store_connect do
    app_store_connect_api_key(
        key_id: "#{ENV["KEY_ID"]}",
        issuer_id: "#{ENV["ISSUER_ID"]}",
        key_content: "#{ENV["KEY_CONTENT"]}",
        duration: "#{ENV["DURATION"]}",
        is_key_content_base64: "#{ENV["IS_KEY_ENCODED"]}",
        in_house: false
    )
  end

end
